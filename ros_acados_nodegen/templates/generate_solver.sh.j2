#!/bin/bash
# This shebang guarantees the script is executed with bash, not /bin/sh

# Exit immediately if any command fails
set -e

# --- Read Arguments from CMake ---
VENV_ACTIVATE_SCRIPT=$1
PYTHON_SCRIPT=$2
ACADOS_EXPORT_CODE=$3

# --- Print for Debugging ---
echo "--- Wrapper script starting..."
echo "--- Venv Activate Script: ${VENV_ACTIVATE_SCRIPT}"
echo "--- Python Script to Run: ${PYTHON_SCRIPT}"
echo "--- Code Generation Path: ${ACADOS_EXPORT_CODE}"

env -i PATH="/usr/local/bin:/usr/bin:/bin" \
bash -c "
  echo '--- Inside clean environment. Set Acados-Paths...'
  export ACADOS_SOURCE_DIR='${ACADOS_SOURCE_DIR}'
  export LD_LIBRARY_PATH='${ACADOS_SOURCE_DIR}/lib'

  echo '--- Activating venv...'
  source '${VENV_ACTIVATE_SCRIPT}'
  echo '--- Running Python script...'
  python3 '${PYTHON_SCRIPT}' --acados_code_export_path '${ACADOS_EXPORT_CODE}'
"

echo "--- Wrapper script finished successfully."